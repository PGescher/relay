generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum WorkoutModule {
  GYM
  RUN
  BIKE
  SWIM
  TENNIS
  PADEL
}

enum UserRole {
  ADMIN
  DEVELOPER
  TESTER
  USER
}

enum ExerciseType {
  strength
  cardio
  mobility
  stretch
  skill
}

enum BodyRegion {
  upper
  lower
  full
  core
}

enum Equipment {
  barbell
  dumbbell
  machine
  cable
  bodyweight
  kettlebell
  band
  cardio_machine
  other
}

enum ExternalProvider {
  STRONG
  STRAVA
  GARMIN
  APPLE_HEALTH
  GOOGLE_FIT
  OTHER
}

model User {
  id String @id @default(uuid())

  // Login / Identität
  username     String  @unique
  email        String? @unique
  displayName  String
  passwordHash String

  // Rollen/Features
  role     UserRole @default(USER)
  // simple + flexibel (später ggf. Feature-Table)
  features String[] @default([])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workouts         Workout[]
  workoutTemplates WorkoutTemplate[]
  exercises        Exercise[]

  currentBodyweightKg Float?
  bodyweightEntries   BodyweightEntry[]
}

model BodyweightEntry {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  at       DateTime @default(now())
  weightKg Float

  source String? // e.g. "manual", "apple_health", "garmin"
  raw    Json? // optional raw payload from provider

  @@index([userId, at])
}

model Workout {
  id     String  @id @default(uuid())
  name   String?
  userId String
  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  module    WorkoutModule
  status    WorkoutStatus @default(planned)
  startTime DateTime      @default(now())
  endTime   DateTime?

  deletedAt DateTime?
  data      Json?

  gym WorkoutGym?
  run WorkoutRun?

  events WorkoutEvent[]

  externalLinks WorkoutExternalLink[]
  sensorSamples WorkoutSensorSample[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  bodyweightKg Float?

  @@index([userId, startTime])
  @@index([module, startTime])
  @@index([deletedAt])
}

model WorkoutEvent {
  id        String  @id @default(uuid())
  workoutId String
  workout   Workout @relation(fields: [workoutId], references: [id], onDelete: Cascade)

  at      DateTime @default(now())
  type    String
  payload Json?

  @@index([workoutId])
  @@index([at])
}

model WorkoutTemplate {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  module WorkoutModule
  name   String
  data   Json

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, module])
}

model Exercise {
  id String @id

  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name        String
  description String?

  type        ExerciseType @default(strength)
  muscleGroup String       @default("Unknown")
  bodyRegion  BodyRegion   @default(upper)

  equipment        Equipment[] @default([])
  primaryMuscles   String[]    @default([])
  secondaryMuscles String[]    @default([])

  isCustom Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  gymUsages WorkoutGymExercise[] // ✅ opposite relation

  @@unique([userId, name])
  @@index([userId])
}

model WorkoutGym {
  id         String  @id @default(uuid())
  workoutId  String  @unique
  workout    Workout @relation(fields: [workoutId], references: [id], onDelete: Cascade)
  rpeOverall Int? // 1..10
  notes      String?

  exercises WorkoutGymExercise[]
}

model WorkoutGymExercise {
  id           String     @id @default(uuid())
  workoutGymId String
  workoutGym   WorkoutGym @relation(fields: [workoutGymId], references: [id], onDelete: Cascade)

  exerciseId String
  exercise   Exercise @relation(fields: [exerciseId], references: [id])

  order Int
  notes String?

  sets WorkoutGymSet[]

  @@index([workoutGymId])
  @@index([exerciseId])
}

model WorkoutGymSet {
  id                   String             @id @default(uuid())
  workoutGymExerciseId String
  workoutGymExercise   WorkoutGymExercise @relation(fields: [workoutGymExerciseId], references: [id], onDelete: Cascade)

  reps   Int?
  weight Float?

  durationSec Int?
  distanceM   Int?

  isCompleted Boolean   @default(false)
  completedAt DateTime?

  restPlannedSec Int?
  restActualSec  Int?

  order Int? // optional: store set order explicitly
  rpe   Float? // per set (0-10, decimals allowed)
  rir   Int? // reps in reserve (0..10 typical)
  tempo String? // e.g. "3-1-1-0"
  notes String? // per-set notes (Strong has per-set "Notizen")

  @@index([workoutGymExerciseId])
  @@index([completedAt])
}

model WorkoutRun {
  id        String  @id @default(uuid())
  workoutId String  @unique
  workout   Workout @relation(fields: [workoutId], references: [id], onDelete: Cascade)

  distanceM       Int?
  durationSec     Int?
  elevationGainM  Int?
  avgHr           Int?
  avgPaceSecPerKm Int?

  notes String?
}

model WorkoutExternalLink {
  id        String  @id @default(uuid())
  workoutId String
  workout   Workout @relation(fields: [workoutId], references: [id], onDelete: Cascade)

  provider   ExternalProvider
  externalId String // provider activity id
  importedAt DateTime         @default(now())
  raw        Json? // store raw payload (or a subset)

  @@unique([provider, externalId])
  @@index([workoutId])
}

model WorkoutSensorSample {
  id        String  @id @default(uuid())
  workoutId String
  workout   Workout @relation(fields: [workoutId], references: [id], onDelete: Cascade)

  at      DateTime
  hr      Int?
  payload Json? // future: cadence, power, etc.

  @@index([workoutId, at])
}

enum WorkoutStatus {
  planned
  active
  completed
  cancelled
}
